<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>SVIT Live Dashboard</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map { height: 350px; width: 100%; border-radius: 12px; margin-bottom: 20px; border: 2px solid #3498db; z-index: 1; }
        .traffic-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #2c3e50; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
    </style>
</head>
<body>

    <div class="card" style="width: 95%; max-width: 1200px; margin: 20px auto; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
            <div>
                <h2 style="margin:0; color: #2c3e50;">SVIT Live Tracker</h2>
                <div id="gpsStatus" style="font-size: 12px; color: #7f8c8d;">Status: System Online</div>
            </div>
            <button onclick="logout()" style="background: #e74c3c; color: white; padding: 10px 15px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Logout</button>
        </div>

        <div id="map"></div>

        <div id="driverControls" style="display:none; background: #e8f8f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #2ecc71;">
            <h3 style="margin-top:0; color: #16a085;">üöç Driver Control Center</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <select id="busId" style="padding:10px; flex:1; border-radius:5px;">
                    <option>GJ-23-y-9599</option><option>GJ-23-aw-0090</option><option>GJ-23-y-9959</option><option>GJ-23-at-9972</option><option>GJ-23-aw-0900</option><option>GJ-23-at-0900</option><option>GJ-23-aw-0909</option><option>GJ-23-at-0909</option><option>GJ-23-aw-9729</option><option>GJ-23-aw-9279</option><option>GJ-23-ay-2799</option><option>GJ-23-ay-3699</option><option>GJ-23-ay-4599</option><option>GJ-23-ay-5499</option><option>GJ-23-ay-7299</option><option>GJ-23-aw-9999</option><option>GJ-23-ay-9999</option><option>GJ-23-aw-8735</option><option>GJ-23-aw-8788</option><option>GJ-23-aw-8982</option>
                </select>
                <select id="routeSelect" style="padding:10px; flex:2; border-radius:5px;"></select>
            </div>
            <button onclick="confirmAllocation()" style="width:100%; margin-top:15px; background:#27ae60; color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px;">üöÄ START TRIP & LIVE GPS</button>
            <button onclick="clearAll()" style="width:100%; margin-top:10px; background:#c0392b; color:white; padding:8px; border:none; border-radius:5px; cursor:pointer;">Reset All Data</button>
        </div>

        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="üîç Find your area (Vasad, Genda Circle, Soma Talav)..." style="width:100%; padding:15px; border-radius:30px; border:1px solid #3498db; margin-bottom:20px; outline:none; font-size: 16px;">

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Bus</th>
                        <th>Route Details</th>
                        <th>ETA & Traffic</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="allocationBody">
                    <tr><td colspan="4" style="text-align:center; padding:30px;">Connecting to SVIT Cloud...</td></tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;">
            <h3 style="color: #c0392b; margin-bottom: 10px;">üö® Emergency Contacts</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="tel:108" style="background:#fff5f5; border:1px solid #feb2b2; padding:12px; border-radius:8px; text-decoration:none; color:#c53030; font-weight:bold; flex:1; text-align:center;">üöë Ambulance: 108</a>
                <a href="tel:100" style="background:#fff5f5; border:1px solid #feb2b2; padding:12px; border-radius:8px; text-decoration:none; color:#c53030; font-weight:bold; flex:1; text-align:center;">üëÆ Police: 100</a>
                <a href="tel:1033" style="background:#fffaf0; border:1px solid #feebc8; padding:12px; border-radius:8px; text-decoration:none; color:#c05621; font-weight:bold; flex:1; text-align:center;">üõ£Ô∏è Highway: 1033</a>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE & DATA ---
        const firebaseConfig = { databaseURL: "https://svit-bus-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const svitLoc = { lat: 22.4552, lon: 73.0745 };

        const svitRoutes = {
            "A-01": "SOMA TALAV, KRISHNA PARK, VRUNDAVAN, RUKSHMANI, SAMA SAVLI ROAD, DUMAD CHOWKDI",
            "A-02": "GURUKUL, PARIVAR CHAR RASTA, MAHESH COMPLEX, KALADARSHAN",
            "A-03": "JIVAN BHARTI SCHOOL, MUKTANAND, AMBALAL PARK, CHARBHUJA COMPLEX, ANAND NAGAR",
            "A-04": "AMIT NAGAR, AMRAPALI, DUMAD CHOWKDI",
            "A-05": "BRIGHT SCHOOL, L&T CIRCLE, EME CIRCLE, UDIPI, SEVEN SEAS MALL",
            "A-06": "MOTI NAGAR, SHIV VATIKA, PANCHIL, DHAVAL NURSING, SANGAM, AIRPORT CIRCLE",
            "A-07": "PUNAM COMPLEX, AYURVEDIC HOSPITAL, SURYA NAGAR, MAHAVIR HALL, MANEK PARK",
            "A-08": "KAMLA NAGAR, SAYAJI BUS STOP, SARDAR ESTATE, KHODIYAR NAGAR, HARNI BRIGHT SCHOOL",
            "A-09": "LAD BHAWAN, RELIENCE, VRUNDAVAN, PRABHAT, ZAVER NAGAR, UMA CHAR RASTA",
            "A-10": "KISHAN VADI, KARELIBAUG WATER TANK",
            "A-11": "GORWA ITI, SAYHOG, PANCHVATI",
            "A-12": "ZYDEX, YASH COMPLEX, ISCON HEIGHT, AMIN PARTY PLOT, LAXMI PURA CIRCLE",
            "A-13": "NATUBHAI CENTER, ELLORA PARK, KALPTARU, CASH AND CARRY, JAIN DERASAR",
            "A-14": "SAMTA, PAVAN DHAM, AAKANKSHA DUPLEX, PUSHPAK TOWNSHIP",
            "A-15": "PRATHAM COMPLEX, ISCON TEMPLE, HARINAGAR, RAJESH TOWER, RANESHWAR, PARLE POINT",
            "A-16": "PANCHMUKHI HANUMAN, BANSAL STORE, TIME CIRCLE, SWAMINARAYAN TEMPLE, D-MART",
            "A-17": "VISHVAMITRI, AKSHAR CHOWK, MANISHA CHOKDI, GENDA CIRCLE, FATHEGUNJ, VASAD",
            "A-18": "VISHVAMITRI, MUNJ MAHUDA, AKOTA GARDEN, URMI CHAR RASTA, RAMA KAKA DERI, VASAD",
            "A-19": "GAYATRINAGAR, MANEJA, NOVINO, SUSSEN, GIDC, VADSAR BRIDGE, KALALI CROSSING",
            "A-20": "SAI CHOKDI, MANJALPUR, DARBAR CHOKDI, TULSIDHAM, RELIENCE CIRCLE, LALBAG, MOTIBAG",
            "A-21": "BARODA DAIRY, KABIR COMPLEX, TULSI DHAM, MANJALPUR NAKA, KALA GHODA, CHHANI JAKAT NAKA",
            "A-22": "TARSALI MARKET, SHARAD NAGAR, ONGC, BARODA DAIRY, RAJMAHAL ROAD, KALAGHODA",
            "A-23": "TULSHIDHAM, TAPAN, DARBAR CHOKDI, MOTI BAG, KIRTI STAMBH, NARHARI, CHHANI JAKAT NAKA",
            "A-24": "RAMESH PATEL ESTATE, SARSWATI COMPLEX, DEEP CHAMBERS, MOTIBAG, SAFFRON TOWER",
            "A-25": "GOYA GATE, GANGOTRI, NAVAPURA POLICE STATION, JAYRATNA BUILDING, POLOGROUND",
            "A-26": "SAMA GARDEN, CHAYANKYA PURI, SWATI SOCIETY, ABHILASHA, M. B. HOSTEL, RAMA KAKA DERI",
            "AR-A-01": "Arch: NOVINO, SUSEN, TULSIDHAM, AKSHAR CHOWK, HARINAGAR, GENDA CIRCLE, VASAD",
            "AR-A-02": "Arch: KALADARSHAN, UMA CHARRASTA, SANGAM, AMIT NAGAR, SAMA, CHHANI JAKAT NAKA"
        };

        // --- 2. MAP SETUP ---
        var map = L.map('map').setView([svitLoc.lat, svitLoc.lon], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var markers = {};
        var busIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [35, 35] });

        // --- 3. ETA LOGIC ---
        function getETA(lat1, lon1, speed) {
            const R = 6371; 
            const dLat = (svitLoc.lat - lat1) * Math.PI / 180;
            const dLon = (svitLoc.lon - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(svitLoc.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const dist = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            const avgSpeed = speed > 5 ? speed : 12;
            return { mins: Math.round((dist / avgSpeed) * 60), isTraffic: speed < 10 };
        }

        // --- 4. CORE FUNCTIONS ---
        window.onload = function() {
            const role = localStorage.getItem("role");
            if (role === "driver") {
                document.getElementById("driverControls").style.display = "block";
                const sel = document.getElementById("routeSelect");
                for (let r in svitRoutes) { sel.options[sel.options.length] = new Option(r + " - " + svitRoutes[r], r); }
            }
        };

        function confirmAllocation() {
            const b = document.getElementById("busId").value;
            const r = document.getElementById("routeSelect").value;
            const stops = svitRoutes[r];
            database.ref('activeBuses/' + r).set({ busId: b, route: r, stops: stops, status: "LIVE" }).then(() => {
                navigator.geolocation.watchPosition(pos => {
                    database.ref('activeBuses/' + r).update({
                        lat: pos.coords.latitude, lon: pos.coords.longitude,
                        speed: (pos.coords.speed || 0) * 3.6, time: new Date().toLocaleTimeString()
                    });
                    document.getElementById("gpsStatus").innerText = "Status: ‚úÖ GPS Sharing Active";
                }, null, { enableHighAccuracy: true });
            });
        }

        database.ref('activeBuses').on('value', snap => {
            const data = snap.val();
            const body = document.getElementById("allocationBody");
            body.innerHTML = "";
            for (let id in markers) { if (!data || !data[id]) { map.removeLayer(markers[id]); delete markers[id]; } }
            if (!data) { body.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px;">No active buses.</td></tr>`; return; }

            for (let k in data) {
                const b = data[k];
                const eta = b.lat ? getETA(b.lat, b.lon, b.speed || 30) : null;
                if (b.lat) {
                    if (markers[k]) markers[k].setLatLng([b.lat, b.lon]);
                    else markers[k] = L.marker([b.lat, b.lon], {icon: busIcon}).addTo(map).bindPopup(`Route ${b.route}`);
                }
                body.innerHTML += `<tr>
                    <td><b>${b.busId}</b></td>
                    <td style="max-width:300px; word-wrap:break-word;"><strong style="color:#2980b9;">${b.route}</strong><br><small>${b.stops}</small></td>
                    <td>${eta ? `<b>${eta.mins} mins</b><br><span class="traffic-badge" style="background:${eta.isTraffic ? '#fed7d7' : '#c6f6d5'}; color:${eta.isTraffic ? '#c53030' : '#276749'}">${eta.isTraffic ? '‚ö†Ô∏è Traffic' : '‚úÖ Smooth'}</span>` : 'Connecting...'}</td>
                    <td><span style="color:green; font-weight:bold;">‚óè LIVE</span></td>
                </tr>`;
            }
        });

        function clearAll() { if(confirm("Clear Data?")) database.ref('activeBuses').remove(); }
        function logout() { localStorage.clear(); window.location.href = "index.html"; }
        function searchTable() {
            let q = document.getElementById("searchInput").value.toUpperCase();
            let rows = document.getElementById("allocationBody").rows;
            for (let r of rows) { r.style.display = r.innerText.toUpperCase().includes(q) ? "" : "none"; }
        }
    </script>
</body>
</html>

